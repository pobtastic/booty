<!DOCTYPE html>
<html>
<head>
<title>Booty: Routine at 43764</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-wide.css" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-75RERFCHBG"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-75RERFCHBG');
</script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="43671.html">43671</a>
</td>
<td class="up">Up: <a href="../maps/all.html#43764">Map</a></td>
<td class="next">
Next: <a href="43844.html">43844</a>
</td>
</tr>
</table>
<div class="description">43764: Unpack Room</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
This is similar to <a href="43671.html">UnpackAllRooms</a>, however instead of copying ALL the room data from the default room data into the room data buffers, this routine copies a single room from the room data buffers into the active room buffer. The reason for this is because the game opens with the default positions for everything held by the defaults but as the player moves around the game and interacts with doors/ keys/ items/ etc, the buffers keep track of what's been collected, and where the pirates were when the player left the room so when they're revisited, they retain those changes.
</div>
</div>
</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="43764"></span>
<div class="comments">
<div class="paragraph">
In <a href="47785.html">TableRoomData</a> the pointers to the room data are stored backwards from 22-1.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">UnpackRoom</td>
<td class="address-2"><span id="43764"></span>43764</td>
<td class="instruction">LD A,(23508)</td>
<td class="comment-1" rowspan="9">Take 22-*<a href="23508.html">TempCurrentRoomID</a> then multiply by 2 (as it's an address we fetch, so 16bit) finally add <a href="47785.html">TableRoomData</a> to point to the correct room buffer data address in the room data table for the current room and store the pointer in <span class="register">HL</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43767"></span>43767</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43768"></span>43768</td>
<td class="instruction">LD A,22</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43770"></span>43770</td>
<td class="instruction">SUB E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43771"></span>43771</td>
<td class="instruction">LD E,A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43772"></span>43772</td>
<td class="instruction">SLA E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43774"></span>43774</td>
<td class="instruction">LD D,0</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43776"></span>43776</td>
<td class="instruction">LD HL,47785</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43779"></span>43779</td>
<td class="instruction">ADD HL,DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43780"></span>43780</td>
<td class="instruction">LD E,(HL)</td>
<td class="comment-1" rowspan="3">Fetch the room buffer data address for the requested room and store it in <span class="register">DE</span>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43781"></span>43781</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43782"></span>43782</td>
<td class="instruction">LD D,(HL)</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43783"></span>43783</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="1">Does nothing, <span class="register">HL</span> is overwritten immediately below.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="43784"></span>
<div class="comments">
<div class="paragraph">
Move the room buffer data address pointer to the room data itself (the first 8 bytes are colour data). There's no need to copy the colours here, as they don't vary between each game.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43784"></span>43784</td>
<td class="instruction">LD HL,8</td>
<td class="comment-1" rowspan="4"><span class="register">DE</span>+=0008 (using the stack).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43787"></span>43787</td>
<td class="instruction">ADD HL,DE</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43788"></span>43788</td>
<td class="instruction">PUSH HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43789"></span>43789</td>
<td class="instruction">POP DE</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="43790"></span>
<div class="comments">
<div class="paragraph">
Now move onto actually copying the room data.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43790"></span>43790</td>
<td class="instruction">LD HL,47831</td>
<td class="comment-1" rowspan="1"><span class="register">HL</span>=<a href="47831.html">BufferCurrentRoomData</a>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="43793"></span>
<div class="comments">
<div class="paragraph">
Set up counters for copying data from the default state to the room buffer.
</div>
<div class="paragraph">
The counter length relates to the length of the data for each instance of the "thing" being copied (NOT the length of the data being copied). For an example; portholes are 0003 bytes of data each, so <span class="register">B</span> is 3 when calling <a href="43970.html">CopyRoomData</a>. How many portholes being copied just depends on when the loop reads a termination character (255).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43793"></span>43793</td>
<td class="instruction">LD B,3</td>
<td class="comment-1" rowspan="2">Handle copying the ... data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43795"></span>43795</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43798"></span>43798</td>
<td class="instruction">LD B,4</td>
<td class="comment-1" rowspan="2">Handle copying the doors data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43800"></span>43800</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43803"></span>43803</td>
<td class="instruction">LD B,2</td>
<td class="comment-1" rowspan="2">Handle copying the ladders data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43805"></span>43805</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43808"></span>43808</td>
<td class="instruction">LD B,6</td>
<td class="comment-1" rowspan="2">Handle copying the keys and locked doors data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43810"></span>43810</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43813"></span>43813</td>
<td class="instruction">LD B,3</td>
<td class="comment-1" rowspan="2">Handle copying the porthole data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43815"></span>43815</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43818"></span>43818</td>
<td class="instruction">LD B,16</td>
<td class="comment-1" rowspan="2">Handle copying the pirate data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43820"></span>43820</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43823"></span>43823</td>
<td class="instruction">LD B,7</td>
<td class="comment-1" rowspan="2">Handle copying the items data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43825"></span>43825</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43828"></span>43828</td>
<td class="instruction">LD B,4</td>
<td class="comment-1" rowspan="2">Handle copying the furniture data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43830"></span>43830</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43833"></span>43833</td>
<td class="instruction">LD B,16</td>
<td class="comment-1" rowspan="2">Handle copying the lifts data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43835"></span>43835</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43838"></span>43838</td>
<td class="instruction">LD B,6</td>
<td class="comment-1" rowspan="2">Handle copying the disappearing floors data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43840"></span>43840</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43843"></span>43843</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return.</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="43671.html">43671</a>
</td>
<td class="up">Up: <a href="../maps/all.html#43764">Map</a></td>
<td class="next">
Next: <a href="43844.html">43844</a>
</td>
</tr>
</table>
<footer>
<div class="release"></div>
<div class="copyright">&copy; 1984 Firebird &copy; 2024 ArcadeGeek LTD.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 9.1.</div>
<div class="repository">Link to <a href="https://github.com/pobtastic/booty/">Source code</a>.</div>
<div><a href="asm/43764.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>