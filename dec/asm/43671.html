<!DOCTYPE html>
<html>
<head>
<title>Booty: Routine at 43671</title>
<meta charset="utf-8" />
<link rel="stylesheet" type="text/css" href="../skoolkit.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-dark.css" />
<link rel="stylesheet" type="text/css" href="../skoolkit-wide.css" />
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-75RERFCHBG"></script>
<script>
window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-75RERFCHBG');
</script>
</head>
<body class="Asm-c">
<table class="header">
<tr>
<td class="logo"><a href="../index.html"><img alt="logo" src="../images/logo.png" /></a></td>
<td class="page-header">Routines</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="43264.html">43264</a>
</td>
<td class="up">Up: <a href="../maps/all.html#43671">Map</a></td>
<td class="next">
Next: <a href="43764.html">43764</a>
</td>
</tr>
</table>
<div class="description">43671: Unpack All Rooms</div>
<table class="disassembly">
<tr>
<td class="routine-comment" colspan="5">
<div class="details">
<div class="paragraph">
This is similar to <a href="43764.html">UnpackRoom</a> except that instead of copying a single rooms data from the room data buffers, this routine loops through ALL the rooms - copying the <a href="43990.html">default room data</a> into the room data buffers. Also, at the start of every loop - it writes the room data buffer address which is about to be processed to the <a href="47785.html">room data table</a> as both the table and the room data buffers are completely blank after the game first loads.
</div>
<div class="paragraph">
Note; this always occurs at the start of every game regardless, the game opens with the default positions for everything held by the defaults but as the player moves around the game and interacts with doors/ keys/ items/ etc, the buffers keep track of what's been collected, and where the pirates were when the player left the room.
</div>
</div>
</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="43671"></span>
<div class="comments">
<div class="paragraph">
When a new game begins, all the rooms are reset to their default states.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">UnpackAllRooms</td>
<td class="address-2"><span id="43671"></span>43671</td>
<td class="instruction">LD HL,47787</td>
<td class="comment-1" rowspan="2">Store the starting room table data reference (starting at <a href="47785.html#47787">33</a>) to *<a href="47781.html">TempTableRoomDataPointer</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43674"></span>43674</td>
<td class="instruction">LD (47781),HL</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="43677"></span>
<div class="comments">
<div class="paragraph">
The idea here is to point to the room data, store this in the table. Then populate this current room, and then we know what the next address value will be for the following rooms starting point.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43677"></span>43677</td>
<td class="instruction">LD DE,48331</td>
<td class="comment-1" rowspan="1">Initialise the starting point of the room data for populating the room table data (<a href="48331.html">33</a>).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43680"></span>43680</td>
<td class="instruction">LD HL,43990</td>
<td class="comment-1" rowspan="1">Initialise the default room data (<a href="43990.html">DefaultRoomData</a>) starting pointer in <span class="register">HL</span>.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="43683"></span>
<div class="comments">
<div class="paragraph">
This part of the loop specifically deals with populating <a href="47785.html">TableRoomData</a>.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">UnpackAllRooms_Loop</td>
<td class="address-2"><span id="43683"></span>43683</td>
<td class="instruction">PUSH HL</td>
<td class="comment-1" rowspan="1">Stash the default room data pointer on the stack.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43684"></span>43684</td>
<td class="instruction">LD HL,(47781)</td>
<td class="comment-1" rowspan="4">Write the address of where the currently in-focus room table data begins to the room table.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43687"></span>43687</td>
<td class="instruction">LD (HL),E</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43688"></span>43688</td>
<td class="instruction">INC HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43689"></span>43689</td>
<td class="instruction">LD (HL),D</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43690"></span>43690</td>
<td class="instruction">INC HL</td>
<td class="comment-1" rowspan="2">Store the position of the next table entry to *<a href="47781.html">TempTableRoomDataPointer</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43691"></span>43691</td>
<td class="instruction">LD (47781),HL</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43694"></span>43694</td>
<td class="instruction">POP HL</td>
<td class="comment-1" rowspan="1">Restore the default room data pointer from the stack.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="43695"></span>
<div class="comments">
<div class="paragraph">
Have we finished with everything?
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43695"></span>43695</td>
<td class="instruction">LD A,(HL)</td>
<td class="comment-1" rowspan="3">If the terminator character (255) has been reached jump to <a href="43671.html#43758">SetRealStartingRoomID</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43696"></span>43696</td>
<td class="instruction">CP 255</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43698"></span>43698</td>
<td class="instruction">JP Z,<a href="43671.html#43758">SetRealStartingRoomID</a></td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="43701"></span>
<div class="comments">
<div class="paragraph">
Now move onto actually copying the room data.
</div>
<div class="paragraph">
Set up counters for copying data from the default state to the room buffer. The counter length relates to the length of the data for each instance of the "thing" being copied (NOT the length of the data being copied). For an example; portholes are 0003 bytes of data each, so <span class="register">B</span> is 3 when calling <a href="43970.html">CopyRoomData</a>. How many portholes being copied just depends on when the loop reads a termination character (255).
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43701"></span>43701</td>
<td class="instruction">LD B,1</td>
<td class="comment-1" rowspan="2">Handle copying the colours (1 loop; this is just one list of bytes).</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43703"></span>43703</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43706"></span>43706</td>
<td class="instruction">LD B,3</td>
<td class="comment-1" rowspan="2">Handle copying the ... data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43708"></span>43708</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43711"></span>43711</td>
<td class="instruction">LD B,4</td>
<td class="comment-1" rowspan="2">Handle copying the doors data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43713"></span>43713</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43716"></span>43716</td>
<td class="instruction">LD B,2</td>
<td class="comment-1" rowspan="2">Handle copying the ladders data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43718"></span>43718</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43721"></span>43721</td>
<td class="instruction">LD B,6</td>
<td class="comment-1" rowspan="2">Handle copying the keys and locked doors data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43723"></span>43723</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43726"></span>43726</td>
<td class="instruction">LD B,3</td>
<td class="comment-1" rowspan="2">Handle copying the porthole data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43728"></span>43728</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43731"></span>43731</td>
<td class="instruction">LD B,16</td>
<td class="comment-1" rowspan="2">Handle copying the pirate data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43733"></span>43733</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43736"></span>43736</td>
<td class="instruction">LD B,7</td>
<td class="comment-1" rowspan="2">Handle copying the items data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43738"></span>43738</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43741"></span>43741</td>
<td class="instruction">LD B,4</td>
<td class="comment-1" rowspan="2">Handle copying the furniture data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43743"></span>43743</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43746"></span>43746</td>
<td class="instruction">LD B,16</td>
<td class="comment-1" rowspan="2">Handle copying the lifts data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43748"></span>43748</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43751"></span>43751</td>
<td class="instruction">LD B,6</td>
<td class="comment-1" rowspan="2">Handle copying the disappearing floors data.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43753"></span>43753</td>
<td class="instruction">CALL <a href="43970.html">CopyRoomData</a></td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43756"></span>43756</td>
<td class="instruction">JR <a href="43671.html#43683">UnpackAllRooms_Loop</a></td>
<td class="comment-1" rowspan="1">Loop back around to <a href="43671.html#43683">UnpackAllRooms_Loop</a>, the unpacking is only finished when the terminator character is read at the start.</td>
</tr>
<tr>
<td class="routine-comment" colspan="5">
<span id="43758"></span>
<div class="comments">
<div class="paragraph">
The room ID of 0 just routed the code here, there is no room 0 - so set the "real" starting room ID.
</div>
</div>
</td>
</tr>
<tr>
<td class="asm-label">SetRealStartingRoomID</td>
<td class="address-2"><span id="43758"></span>43758</td>
<td class="instruction">LD A,1</td>
<td class="comment-1" rowspan="2">Write 1 to *<a href="23507.html">CurrentRoom</a>.</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43760"></span>43760</td>
<td class="instruction">LD (23507),A</td>
</tr>
<tr>
<td class="asm-label"></td>
<td class="address-1"><span id="43763"></span>43763</td>
<td class="instruction">RET</td>
<td class="comment-1" rowspan="1">Return.</td>
</tr>
</table>
<table class="asm-navigation">
<tr>
<td class="prev">
Prev: <a href="43264.html">43264</a>
</td>
<td class="up">Up: <a href="../maps/all.html#43671">Map</a></td>
<td class="next">
Next: <a href="43764.html">43764</a>
</td>
</tr>
</table>
<footer>
<div class="release"></div>
<div class="copyright">&copy; 1984 Firebird &copy; 2024 ArcadeGeek LTD.</div>
<div class="created">Created using <a href="https://skoolkit.ca">SkoolKit</a> 9.1.</div>
<div class="repository">Link to <a href="https://github.com/pobtastic/booty/">Source code</a>.</div>
<div><a href="asm/43671.html">Switch to hexadecimal</a>.</div>
</footer>
</body>
</html>